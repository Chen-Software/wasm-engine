#!/usr/bin/env bash
set -x # Enable debug tracing

exec >> /tmp/post-commit.log 2>&1

echo "--- Post-commit hook started ---"
echo "Time: $(date)"
echo "Current directory: $(pwd)"

# Get the current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "Current branch: $CURRENT_BRANCH"

# --- Invariant P4: Unidirectional Authority ---
if [ "$CURRENT_BRANCH" = "data" ]; then
  echo "Branch is 'data', exiting."
  exit 0
fi

# Get the full SHA of the latest commit.
COMMIT_SHA=$(git rev-parse HEAD)
echo "Commit SHA: $COMMIT_SHA"

# Get the absolute path to the project's root directory.
PROJECT_ROOT=$(git rev-parse --show-toplevel)
echo "Project root: $PROJECT_ROOT"

PROJECTOR_SCRIPT="$PROJECT_ROOT/prototype/phase-1/tools/projector.sh"
echo "Projector script path: $PROJECTOR_SCRIPT"

if [ ! -f "$PROJECTOR_SCRIPT" ]; then
  echo "Error: Projector script not found!"
  exit 1
fi

# Call the projector script, passing the commit SHA.
"$PROJECTOR_SCRIPT" "$COMMIT_SHA"

echo "--- Post-commit hook finished ---"
